@page "/export"
@inject JournalService journalService
@inject AuthenticationService authService
@inject PdfExportService pdfExportService
@inject IJSRuntime JSRuntime
@using Inkwell_Kunal.Services
@using Microsoft.JSInterop

<PageTitle>Export Journals - Inkwell Journal</PageTitle>

<div class="export-container">
    <h3>Export Journals</h3>
    <div class="export-card">
        <p class="text-muted">Export your journal entries to PDF format.</p>

        <!-- Date Range Selection -->
        <div class="date-grid">
            <div class="date-field">
                <label class="form-label">Start Date</label>
                <input type="date" class="form-control" @bind="exportFromDate" />
            </div>
            <div class="date-field">
                <label class="form-label">End Date</label>
                <input type="date" class="form-control" @bind="exportToDate" />
            </div>
        </div>

        <div class="export-button">
            <button class="btn btn-success btn-lg" @onclick="ExportToPdf" disabled="@isExporting">
                @if (isExporting)
                {
                    <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                    <span>Exporting</span>
                }
                else
                {
                    <span>Export to PDF</span>
                }
            </button>
        </div>

        @if (!string.IsNullOrEmpty(message))
        {
            <div class="alert alert-info">@message</div>
        }
    </div>
</div>

<style>
    .export-container {
        max-width: 600px;
        margin: 0 auto;
    }
    .export-container h3 {
        color: #2d3748;
        margin-bottom: 2rem;
    }
    .export-card {
        background-color: #ffffff;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        padding: 2rem;
        transition: transform 0.3s ease;
    }
    .export-card:hover {
        transform: translateY(-2px);
    }
    .date-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }
    .date-field label {
        color: #4a5568;
        margin-bottom: 0.5rem;
        display: block;
    }
    .export-button {
        text-align: center;
        margin-bottom: 1rem;
    }
    .alert {
        border-radius: 8px;
    }
</style>

@code {
    [Inject] NavigationManager Navigation { get; set; } = default!;

    private DateTime? exportFromDate;
    private DateTime? exportToDate;
    private bool isExporting = false;
    private string? message;

    protected override void OnInitialized()
    {
        // Default to last 30 days
        exportToDate = DateTime.Today;
        exportFromDate = DateTime.Today.AddDays(-30);
    }

    private async Task ExportToPdf()
    {
        if (!exportFromDate.HasValue || !exportToDate.HasValue)
        {
            message = "Please select both start and end dates.";
            return;
        }

        if (exportFromDate > exportToDate)
        {
            message = "Start date cannot be after end date.";
            return;
        }

        isExporting = true;
        message = "Preparing export...";

        try
        {
            var entries = await journalService.GetAllEntriesAsync();
            var entriesToExport = entries
                .Where(e => e.Date >= exportFromDate.Value.Date && e.Date <= exportToDate.Value.Date)
                .OrderBy(e => e.Date)
                .ToList();

            if (!entriesToExport.Any())
            {
                message = "No entries found in the selected date range.";
                return;
            }

            var userName = authService.CurrentUser?.Username ?? "User";
            var pdfBytes = pdfExportService.GenerateJournalPdf(entriesToExport, userName);

            // Save file using JS
            await JSRuntime.InvokeVoidAsync("downloadFile",
                $"journal_export_{exportFromDate:yyyy-MM-dd}_to_{exportToDate:yyyy-MM-dd}.pdf",
                Convert.ToBase64String(pdfBytes));

            message = $"Successfully exported {entriesToExport.Count} entries!";
        }
        catch (Exception ex)
        {
            message = $"Export failed: {ex.Message}";
        }
        finally
        {
            isExporting = false;
        }
    }
}