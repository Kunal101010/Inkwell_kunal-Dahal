@page "/mood-analytics"
@inject JournalService journalService
@inject AuthenticationService authService
@using Inkwell_Kunal.Services
@using Inkwell_Kunal.Data

<PageTitle>Mood Analytics - Inkwell Journal</PageTitle>

<div class="mood-analytics-container">
    <h3>Mood Analytics</h3>
    <div class="analytics-overview">
        <div class="overview-card">
            <div class="card-icon">ðŸ˜Š</div>
            <div class="card-content">
                <h5>Average Mood</h5>
                <p class="mood-score">@averageMood.ToString("F1")/10</p>
                <small>Last 30 days</small>
            </div>
        </div>
        <div class="overview-card">
            <div class="card-icon">ðŸ“Š</div>
            <div class="card-content">
                <h5>Total Entries</h5>
                <p class="mood-score">@moodTrends.Count</p>
                <small>Days with entries</small>
            </div>
        </div>
        <div class="overview-card">
            <div class="card-icon">ðŸ“ˆ</div>
            <div class="card-content">
                <h5>Most Common</h5>
                <p class="mood-score">@(moodTrends.GroupBy(m => m.Mood).OrderByDescending(g => g.Count()).FirstOrDefault()?.Key ?? "N/A")</p>
                <small>Primary mood</small>
            </div>
        </div>
    </div>

    <div class="analytics-sections">
        <div class="analytics-card large">
            <h4>Mood Trends (Last 30 Days)</h4>
            <div class="trends-list">
                @if (moodTrends.Any())
                {
                    @foreach (var trend in moodTrends)
                    {
                        <div class="trend-item">
                            <div class="trend-date">@trend.Date.ToString("MMM dd")</div>
                            <div class="trend-bar-container">
                                <div class="trend-bar" style="width: @(trend.Value / 10.0 * 100)%"></div>
                            </div>
                            <div class="trend-mood">@trend.Mood</div>
                            <div class="trend-value">@trend.Value.ToString("F1")</div>
                        </div>
                    }
                }
                else
                {
                    <p class="text-muted">No mood data available.</p>
                }
            </div>
        </div>

        <div class="analytics-card">
            <h4>Mood Distribution</h4>
            <div class="mood-distribution">
                @{
                    var moodCounts = moodTrends
                        .GroupBy(m => m.Mood)
                        .OrderByDescending(g => g.Count())
                        .ToList();
                }
                @foreach (var moodGroup in moodCounts)
                {
                    var percentage = (double)moodGroup.Count() / moodTrends.Count * 100;
                    <div class="mood-bar">
                        <div class="mood-label">@moodGroup.Key</div>
                        <div class="mood-bar-container">
                            <div class="mood-bar-fill" style="width: @(percentage)%"></div>
                        </div>
                        <div class="mood-count">@moodGroup.Count() (@percentage.ToString("F0")%)</div>
                    </div>
                }
            </div>
        </div>

        <div class="analytics-card">
            <h4>Recent Entries</h4>
            <div class="recent-list">
                @if (recentEntries.Any())
                {
                    @foreach (var entry in recentEntries.OrderByDescending(e => e.Date).Take(10))
                    {
                        <div class="recent-item">
                            <div class="recent-date">@entry.Date.ToShortDateString()</div>
                            <div class="recent-title">@(string.IsNullOrWhiteSpace(entry.Title) ? "Untitled" : entry.Title)</div>
                            <div class="recent-mood">@entry.PrimaryMood</div>
                        </div>
                    }
                }
                else
                {
                    <p class="text-muted">No entries found.</p>
                }
            </div>
        </div>
    </div>
</div>

<style>
    .mood-analytics-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem;
    }
    .mood-analytics-container h3 {
        color: #2d3748;
        text-align: center;
        margin-bottom: 2rem;
        font-size: 1.8rem;
    }
    .analytics-overview {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    .overview-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 12px;
        padding: 1.5rem;
        display: flex;
        align-items: center;
        gap: 1rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease;
    }
    .overview-card:hover {
        transform: translateY(-5px);
    }
    .overview-card:nth-child(2) {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
    .overview-card:nth-child(3) {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }
    .card-icon {
        font-size: 2.5rem;
    }
    .card-content h5 {
        margin: 0 0 0.25rem 0;
        font-size: 0.9rem;
        opacity: 0.9;
    }
    .mood-score {
        font-size: 1.8rem;
        font-weight: bold;
        margin: 0.25rem 0;
    }
    .card-content small {
        opacity: 0.8;
        font-size: 0.85rem;
    }
    .analytics-sections {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 2rem;
    }
    .analytics-card {
        background-color: #ffffff;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        padding: 2rem;
    }
    .analytics-card.large {
        grid-column: 1 / -1;
    }
    .analytics-card h4 {
        color: #2d3748;
        margin-bottom: 1.5rem;
        border-bottom: 2px solid #e2e8f0;
        padding-bottom: 0.5rem;
    }
    .trends-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }
    .trend-item {
        display: grid;
        grid-template-columns: 60px 1fr 80px 50px;
        align-items: center;
        gap: 1rem;
        padding: 0.75rem;
        background-color: #f7fafc;
        border-radius: 8px;
    }
    .trend-date {
        font-weight: 600;
        color: #4a5568;
        font-size: 0.9rem;
    }
    .trend-bar-container {
        height: 30px;
        background-color: #e2e8f0;
        border-radius: 4px;
        overflow: hidden;
    }
    .trend-bar {
        height: 100%;
        background: linear-gradient(90deg, #68d391, #48bb78);
        transition: width 0.3s ease;
    }
    .trend-mood {
        font-weight: 500;
        color: #2d3748;
    }
    .trend-value {
        text-align: right;
        font-weight: 600;
        color: #667eea;
    }
    .mood-distribution {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }
    .mood-bar {
        display: grid;
        grid-template-columns: 80px 1fr 80px;
        align-items: center;
        gap: 1rem;
    }
    .mood-label {
        font-weight: 600;
        color: #4a5568;
    }
    .mood-bar-container {
        height: 25px;
        background-color: #e2e8f0;
        border-radius: 4px;
        overflow: hidden;
    }
    .mood-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, #667eea, #764ba2);
        transition: width 0.3s ease;
    }
    .mood-count {
        text-align: right;
        font-size: 0.9rem;
        color: #718096;
    }
    .recent-list {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }
    .recent-item {
        display: grid;
        grid-template-columns: 70px 1fr 80px;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
        background-color: #f7fafc;
        border-radius: 8px;
        border-left: 4px solid #667eea;
    }
    .recent-date {
        font-size: 0.85rem;
        color: #718096;
        font-weight: 500;
    }
    .recent-title {
        color: #2d3748;
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .recent-mood {
        text-align: right;
        font-size: 0.9rem;
        font-weight: 600;
        color: #48bb78;
    }
    .text-muted {
        color: #a0aec0;
    }
    @@media (max-width: 768px) {
        .analytics-sections {
            grid-template-columns: 1fr;
        }
        .analytics-card.large {
            grid-column: 1;
        }
        .trend-item {
            grid-template-columns: 60px 1fr 50px;
        }
        .trend-value {
            display: none;
        }
    }
</style>

@code {
    private double averageMood;
    private List<MoodTrend> moodTrends = new();
    private List<JournalEntry> recentEntries = new();

    protected override async Task OnInitializedAsync()
    {
        var entries = await journalService.GetAllEntriesAsync();
        var last30Days = entries.Where(e => e.Date >= DateTime.Today.AddDays(-30)).OrderBy(e => e.Date).ToList();
        
        if (last30Days.Any())
        {
            averageMood = last30Days.Average(e => GetMoodValue(e.PrimaryMood));
            recentEntries = last30Days.Take(5).ToList();
            
            // Prepare trend data
            var grouped = last30Days.GroupBy(e => e.Date.Date).OrderBy(g => g.Key);
            moodTrends = grouped.Select(g => new MoodTrend
            {
                Date = g.Key,
                Mood = g.First().PrimaryMood ?? "Unknown",
                Value = g.Average(e => GetMoodValue(e.PrimaryMood))
            }).ToList();
        }
    }

    private double GetMoodValue(string? mood)
    {
        return mood switch
        {
            "Happy" => 8,
            "Neutral" => 5,
            "Sad" => 2,
            _ => 5
        };
    }

    private class MoodTrend
    {
        public DateTime Date { get; set; }
        public string Mood { get; set; }
        public double Value { get; set; }
    }
}