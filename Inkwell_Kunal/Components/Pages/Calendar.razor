@page "/calendar"
@using Inkwell_Kunal.Data
@using Inkwell_Kunal.Data.Models
@inject IJournalService JournalService
@inject NavigationManager NavManager

<div class="calendar-root">
    <div class="calendar-header mb-3 d-flex align-items-center justify-content-between">
        <div class="d-flex align-items-center">
            <button class="btn btn-light me-2" @onclick="PrevMonth" aria-label="Previous month">◀</button>
            <div class="fs-5 fw-bold">@DisplayMonthName</div>
            <button class="btn btn-light ms-2" @onclick="NextMonth" aria-label="Next month">▶</button>
            <button class="btn btn-outline-secondary ms-3" @onclick="GoToToday">Today</button>
        </div>
        <div class="calendar-legend text-muted d-none d-md-flex">
            <div class="me-3">Legend:</div>
            @foreach(var m in LegendMoods)
            {
                <div class="d-flex align-items-center me-2">
                    <span class="mood-dot me-1" style="background:@GetMoodColor(m)"></span>
                    <small>@m</small>
                </div>
            }
        </div>
    </div>

    <div class="calendar-grid" role="grid" aria-label="Journal calendar">
        <div class="calendar-weekdays d-flex fw-bold">
            @foreach (var wd in WeekDays) { <div class="calendar-weekday">@wd</div>; }
        </div>

        @foreach (var week in CalendarMatrix)
        {
            <div class="calendar-week d-flex">
                @foreach (var day in week)
                {
                    if (day == null)
                    {
                        <div class="calendar-cell empty" aria-hidden="true"></div>
                    }
                    else
                    {
                        var date = day.Value.Date;
                        EntriesByDate.TryGetValue(date, out var entry);
                        var isToday = date == DateTime.UtcNow.Date;
                        var preview = entry is null ? "No entry" : GetPreview(entry);
                        <div class="calendar-cell" role="gridcell" tabindex="0" aria-label="@date.ToString("D") - @(entry==null?"No entry":entry.Title)" title="@preview">
                            <div class="calendar-cell-top d-flex justify-content-between align-items-start">
                                <div class="calendar-day-number">@date.Day</div>
                                @if (isToday)
                                {
                                    <div class="badge bg-info text-dark small">Today</div>
                                }
                            </div>

                            <div class="calendar-cell-body mt-1">
                                @if (entry != null)
                                {
                                    <div class="d-flex align-items-center mb-1">
                                        <span class="mood-dot me-2" style="background:@GetMoodColor(entry.PrimaryMood)"></span>
                                        <div class="fw-semibold small text-truncate">@entry.Title</div>
                                    </div>
                                    <div class="tag-row">
                                        @foreach (var t in entry.Tags.Take(3))
                                        {
                                            <span class="tag-chip">@t</span>
                                        }
                                    </div>
                                }
                                else
                                {
                                    <div class="text-muted small">No entry</div>
                                }
                            </div>

                            <div class="calendar-cell-actions mt-2 d-flex justify-content-between">
                                <button class="btn btn-sm btn-outline-primary" @onclick="() => OpenDay(date)" aria-label="Open @date.ToString("yyyy-MM-dd")">Open</button>
                                <button class="btn btn-sm btn-light" @onclick="() => QuickAdd(date)" aria-label="Add entry for @date.ToString("yyyy-MM-dd")">Add</button>
                            </div>
                        </div>
                    }
                }
            </div>
        }
    </div>
</div>

@code {
    private DateTime CurrentMonth = new DateTime(DateTime.UtcNow.Year, DateTime.UtcNow.Month, 1);
    private string[] WeekDays = new[] { "Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat" };
    private List<DateTime?[]> CalendarMatrix = new();
    private Dictionary<DateTime, JournalEntry> EntriesByDate = new();
    private string DisplayMonthName => CurrentMonth.ToString("Y");
    private string[] LegendMoods => new[] { "Happy", "Calm", "Sad" };

    protected override async Task OnInitializedAsync()
    {
        await LoadCalendar();
    }

    private async Task LoadCalendar()
    {
        BuildMatrix();
        EntriesByDate.Clear();
        var start = CalendarMatrix.SelectMany(r => r).Where(d => d.HasValue).Select(d => d!.Value.Date).DefaultIfEmpty(CurrentMonth.Date).Min();
        var end = CalendarMatrix.SelectMany(r => r).Where(d => d.HasValue).Select(d => d!.Value.Date).DefaultIfEmpty(CurrentMonth.Date).Max().AddDays(1);
        var entries = await JournalService.GetEntriesForRangeAsync(start, end);
        foreach (var e in entries)
        {
            EntriesByDate[e.CreatedAt.Date] = e;
        }
    }

    private void BuildMatrix()
    {
        CalendarMatrix.Clear();
        var firstOfMonth = new DateTime(CurrentMonth.Year, CurrentMonth.Month, 1);
        var start = firstOfMonth;
        while ((int)start.DayOfWeek != 0) start = start.AddDays(-1); // go back to Sunday
        var lastOfMonth = firstOfMonth.AddMonths(1).AddDays(-1);
        var end = lastOfMonth;
        while ((int)end.DayOfWeek != 6) end = end.AddDays(1); // go forward to Saturday

        var cur = start;
        while (cur <= end)
        {
            var week = new DateTime?[7];
            for (int i = 0; i < 7; i++)
            {
                week[i] = cur;
                cur = cur.AddDays(1);
            }
            CalendarMatrix.Add(week);
        }
    }

    private async Task PrevMonth()
    {
        CurrentMonth = CurrentMonth.AddMonths(-1);
        await LoadCalendar();
    }

    private async Task NextMonth()
    {
        CurrentMonth = CurrentMonth.AddMonths(1);
        await LoadCalendar();
    }

    private async Task GoToToday()
    {
        CurrentMonth = new DateTime(DateTime.UtcNow.Year, DateTime.UtcNow.Month, 1);
        await LoadCalendar();
    }

    private void OpenDay(DateTime date)
    {
        var qs = $"?date={date:yyyy-MM-dd}";
        NavManager.NavigateTo($"/journal{qs}");
    }

    private void QuickAdd(DateTime date)
    {
        // Navigate to the journal page for that date; user can quickly create entry there.
        OpenDay(date);
    }

    private string GetPreview(JournalEntry e)
    {
        var content = (e.Content ?? string.Empty).Replace("\n", " ").Trim();
        var preview = string.IsNullOrWhiteSpace(e.Title) ? content : (e.Title + " — " + content);
        if (preview.Length > 140) preview = preview.Substring(0, 137) + "...";
        return preview;
    }

    private string GetMoodColor(string? mood)
    {
        if (string.IsNullOrEmpty(mood)) return "#cccccc";
        return mood.ToLowerInvariant() switch
        {
            var s when s.Contains("happy") || s.Contains("excited") => "#29b57a",
            var s when s.Contains("calm") || s.Contains("relaxed") || s.Contains("thoughtful") => "#6fa8dc",
            var s when s.Contains("sad") || s.Contains("lonely") || s.Contains("stressed") => "#e05a5a",
            _ => "#7a7a7a"
        };
    }
}
